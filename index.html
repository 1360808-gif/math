<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>あまりのある わり算（3年生）</title>

<style>
:root{
  --bg:#f7f8ff;
  --ink:#1f2937;
  --line:#e5e7eb;
  --accent:#4f46e5;
  --shadow:0 10px 24px rgba(0,0,0,.08);
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
  background:var(--bg);
  color:var(--ink);
}
.wrap{ max-width:1200px; margin:16px auto; padding:0 12px 40px; }

/* 左：タイトル+問題 / 右：手書き */
.layout{
  display:grid;
  grid-template-columns: minmax(560px, 760px) 1fr;
  gap:12px;
  align-items:start;
}
@media(max-width:980px){
  .layout{ grid-template-columns:1fr; }
}

.top{
  background:#fff;
  border:1px solid var(--line);
  border-radius:24px;
  padding:14px;
  box-shadow:var(--shadow);
}
h1{ margin:0 0 8px; font-size:22px; }

.controlsRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

button{
  padding:9px 12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:900;
  cursor:pointer;
}
button.primary{
  background:var(--accent);
  color:#fff;
  border-color:transparent;
}

.panel{
  background:#fff;
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  box-shadow:0 6px 12px rgba(0,0,0,.06);
}

/* ===== 問題 ===== */
.grid{
  margin-top:12px;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
@media(max-width:700px){
  .grid{ grid-template-columns:1fr; }
}

.q{
  border:1px solid var(--line);
  border-radius:18px;
  padding:12px;
  box-shadow:0 6px 12px rgba(0,0,0,.06);
  overflow:visible; /* ★切らない */
}

.qRow{
  display:flex;
  align-items:center;
  gap:10px;
  overflow:visible; /* ★切らない */
}

/* ★ここが最大の修正点 */
.qInline{
  display:flex;
  align-items:center;
  gap:8px;
  flex:1;
  min-width:0;
  white-space:nowrap;
  overflow:visible; /* ← hidden を完全にやめる */
}

.expr{
  font-size:18px;
  font-weight:1000;
}

/* 入力欄 */
.answerBox{
  position:relative;
  display:inline-block;
  overflow:visible; /* ★丸を切らない */
}

.answerBox input{
  width:54px;
  padding:6px;
  font-size:17px;
  text-align:center;
  border-radius:10px;
  border:2px solid var(--line);
  background:#fff;
  position:relative;
  z-index:1;
}

/* 半角注意 */
.hankakuWarn{
  position:absolute;
  top:-26px;
  left:50%;
  transform:translateX(-50%);
  background:#fee2e2;
  color:#b91c1c;
  font-size:12px;
  font-weight:900;
  padding:4px 8px;
  border-radius:8px;
  display:none;
  z-index:20;
}
.answerBox.warn .hankakuWarn{ display:block; }

/* ★正答の丸（完全最前面・欠けない） */
.mark{
  position:absolute;
  top:50%;
  left:50%;
  width:48px;
  height:48px;
  border:4px solid rgba(239,68,68,0.75);
  border-radius:50%;
  transform:translate(-50%, -50%);
  pointer-events:none;
  display:none;
  z-index:9999;
}
.answerBox.ok .mark{ display:block; }

.remLabel{
  font-size:14px;
  font-weight:1000;
}

/* 答えを見るボタン */
.smallBtn{
  width:60px;
  height:38px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#fff;
  font-weight:900;
  display:grid;
  place-items:center;
  cursor:pointer;
}
.smallBtn span{
  display:block;
  font-size:12px;
  line-height:1.05;
}

.score{
  margin-top:14px;
  font-weight:1000;
  font-size:18px;
}

/* ===== 手書き ===== */
.canvasWrap{
  border:2px dashed #cbd5e1;
  border-radius:16px;
}
#board{
  width:100%;
  height:640px;
  display:block;
  touch-action:none;
}
</style>
</head>

<body>
<div class="wrap">

<div class="layout">

<!-- 左 -->
<div>
  <div class="top">
    <h1>あまりのある わり算（3年生）</h1>
    <button class="primary" id="checkBtn">こたえあわせ</button>
    <button id="makeBtn">もんだいをつくる</button>
  </div>

  <div class="panel" style="margin-top:12px;">
    <div class="grid" id="qs"></div>
    <div class="score" id="score">点数：— / 100</div>
  </div>
</div>

<!-- 右 -->
<div class="panel">
  <p style="font-weight:900;">✍ 手書き計算スペース</p>
  <div class="canvasWrap">
    <canvas id="board"></canvas>
  </div>
</div>

</div>
</div>

<script>
function toHalfWidth(str){
  return str.replace(/[０-９]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
}
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

let problems=[];
const QNUM=10;

function makeProblems(){
  const out=[], set=new Set();
  while(out.length<QNUM){
    const b=rand(2,9), q=rand(2,9), r=rand(1,b-1);
    const a=b*q+r, key=`${a}/${b}`;
    if(set.has(key)) continue;
    set.add(key);
    out.push({a,b,q,r});
  }
  return out;
}

function render(){
  const qs=document.getElementById("qs");
  qs.innerHTML="";

  problems.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="q";
    d.innerHTML=`
      <div class="qRow">
        <div class="qInline">
          <span class="expr">${p.a} ÷ ${p.b} =</span>

          <span class="answerBox qBox">
            <span class="hankakuWarn">半角で入力してね</span>
            <input class="ansQ">
            <span class="mark"></span>
          </span>

          <span class="remLabel">あまり</span>

          <span class="answerBox rBox">
            <span class="hankakuWarn">半角で入力してね</span>
            <input class="ansR">
            <span class="mark"></span>
          </span>
        </div>

        <button class="smallBtn holdBtn">
          <span>こたえを</span><span>みる</span>
        </button>
      </div>
    `;
    qs.appendChild(d);

    const qI=d.querySelector(".ansQ");
    const rI=d.querySelector(".ansR");
    const qB=d.querySelector(".qBox");
    const rB=d.querySelector(".rBox");
    const btn=d.querySelector(".holdBtn");

    [qI,rI].forEach(inp=>{
      inp.addEventListener("input",e=>{
        const before=e.target.value;
        const after=toHalfWidth(before);
        if(before!==after){
          const box=e.target.parentElement;
          box.classList.add("warn");
          setTimeout(()=>box.classList.remove("warn"),1500);
        }
        e.target.value=after;
      });
    });

    let sq="", sr="";
    btn.onmousedown=()=>{
      sq=qI.value; sr=rI.value;
      qI.value=p.q; rI.value=p.r;
    };
    window.onmouseup=()=>{
      qI.value=sq; rI.value=sr;
    };
  });

  document.getElementById("score").textContent="点数：— / 100";
}

function check(){
  let score=0;
  document.querySelectorAll(".q").forEach((q,i)=>{
    const qb=q.querySelector(".qBox");
    const rb=q.querySelector(".rBox");
    qb.classList.remove("ok"); rb.classList.remove("ok");

    const uq=Number(q.querySelector(".ansQ").value);
    const ur=Number(q.querySelector(".ansR").value);
    if(uq===problems[i].q) qb.classList.add("ok");
    if(ur===problems[i].r) rb.classList.add("ok");
    if(uq===problems[i].q && ur===problems[i].r) score+=10;
  });
  document.getElementById("score").textContent=`点数：${score} / 100`;
}

document.getElementById("checkBtn").onclick=check;
document.getElementById("makeBtn").onclick=()=>{ problems=makeProblems(); render(); };

problems=makeProblems();
render();
</script>
</body>
</html>
